---
import sharp from 'sharp';
import { nanoid } from 'nanoid';

export type Props = {
  path: string;
  name: string;
  alt: string;
  widths: Array<number>;
  borderRadiusTop?: string;
  borderRadiusBottom?: string;
};

const { path, name, alt, widths, borderRadiusTop, borderRadiusBottom } =
  Astro.props as Props;

const baseImagePath = `${import.meta.env.STORAGE_URL}/${
  import.meta.env.CLOUD_STORAGE_BUCKET
}/${path}/${name}`;

// build placeholder image from 800w image
const smallImageSrc = `${baseImagePath}-800w.webp`;
const maxWidth = widths[widths.length - 1];
const defaultSrc = `${baseImagePath}-${maxWidth}w.jpg`;

const res = await fetch(smallImageSrc);

const arrayBuffer = await res.arrayBuffer();
const buffer = Buffer.from(arrayBuffer);
const sharpImage = sharp(buffer);

const { format } = await sharpImage.metadata();

const initImg = await sharpImage
  .resize({ width: 50, fit: 'inside' })
  .blur()
  .toBuffer();

const initSrc = `data:image/${format};base64,${initImg.toString('base64')}`;

const jpegSrcset = widths
  .map((width) => `${baseImagePath}-${width}w.jpg ${width}w`)
  .join(',');
const webpSrcset = widths
  .map((width) => `${baseImagePath}-${width}w.webp ${width}w`)
  .join(',');

const imgId = nanoid(6);
---

<img
  data-placeholder-id={imgId}
  class="placeholder"
  src={initSrc}
  width={2400}
  style={{
    'border-top-left-radius': borderRadiusTop ?? 0,
    'border-top-right-radius': borderRadiusTop ?? 0,
    'border-bottom-left-radius': borderRadiusBottom ?? 0,
    'border-bottom-right-radius': borderRadiusBottom ?? 0,
  }}
/>
<picture>
  <source
    type="image/webp"
    sizes="(max-width: 1024px) 100vw, 1024px"
    srcset={webpSrcset}
  />
  <source
    type="image/jpeg"
    sizes="(max-width: 1024px) 100vw, 1024px"
    srcset={jpegSrcset}
  />
  <img
    style={{
      'border-top-left-radius': borderRadiusTop ?? 0,
      'border-top-right-radius': borderRadiusTop ?? 0,
      'border-bottom-left-radius': borderRadiusBottom ?? 0,
      'border-bottom-right-radius': borderRadiusBottom ?? 0,
      display: 'none',
    }}
    class="picture"
    data-img-id={imgId}
    alt={alt}
    src={defaultSrc}
  />
</picture>

<script>
  import imageLoader from '@src/scripts/imageLoader';
  imageLoader();
</script>

<style lang="css">
  .picture,
  .placeholder {
    display: block;
    margin: auto;
    max-width: 100%;
  }
</style>

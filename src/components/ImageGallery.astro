---
import BaseImage from './BaseImage.astro';
import SlideshowIcon from '~icons/tabler/slideshow';
import 'photoswipe/style.css';
import 'photoswipe-dynamic-caption-plugin/photoswipe-dynamic-caption-plugin.css';

import sharp from 'sharp';
import { buildImages } from '@src/utils/images';

export type Props = {
  preview: {
    title: string;
    src: string;
  };
  images?: Array<{
    src: string;
    caption: string;
  }>;
  rangeOptions?: {
    base: string;
    suffix: string;
    digits: number;
    start: number;
    end: number;
    description: string;
  };
};

const { images, rangeOptions, preview } = Astro.props as Props;

const imagesToFetch = images ?? buildImages(rangeOptions);

const imageData = await Promise.all(
  imagesToFetch.map(async (image) => {
    const finalSrc = `${import.meta.env.PUBLIC_IMAGE_BASE_URL}${image.src}`;
    console.log('finalSrc', finalSrc);
    const res = await fetch(finalSrc);

    const arrayBuffer = await res.arrayBuffer();
    const buffer = Buffer.from(arrayBuffer);
    console.log(buffer);
    const sharpImage = sharp(buffer);
    console.log(sharpImage);

    const { width, height, format } = await sharpImage.metadata();
    return {
      src: finalSrc,
      alt: image.caption,
      caption: image.caption,
      width,
      height,
      format,
    };
  })
);
---

<div>
  <button data-images={JSON.stringify(imageData)} class="gallery-button">
    <BaseImage src={preview.src} alt={preview.title} borderRadiusTop="1em" />
    <SlideshowIcon class="gallery-icon" />
    <h5 class="title">{preview.title}</h5>
    <p class="prompt"><em>Click to Open</em></p>
  </button>
</div>

<style>
  .title {
    text-align: center;
    margin: 0.5em auto;
  }

  .gallery-button {
    all: unset;
    display: block;
    cursor: pointer;
    margin: 1em auto;
    max-width: 400px;
    box-shadow: 0 4px 8px #002d5baa;
    transition: var(--dt);
    border-radius: 1em;

    &:hover {
      box-shadow: 0 8px 16px #002d5baa;
    }
  }

  .gallery-icon {
    display: block;
    margin: 0.25em auto;
    font-size: 4em;
    color: var(--color1);
  }

  .prompt {
    font-size: 1rem;
    text-align: center;
  }

  .selected {
    visibility: visible;
    opacity: 1;
    transition: visibility 0s, opacity 0.5s linear;
  }

  .unselected {
    visibility: hidden;
    opacity: 0;
    display: none;
  }
</style>

<script>
  import initializePhotoGalleries from '@src/scripts/imageGallery';

  initializePhotoGalleries();
</script>

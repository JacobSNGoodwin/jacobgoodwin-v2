---
import BaseImage from './BaseImage.astro';
import SlideshowIcon from '~icons/tabler/slideshow';
import 'photoswipe/style.css';
import 'photoswipe-dynamic-caption-plugin/photoswipe-dynamic-caption-plugin.css';

import sharp from 'sharp';
import { buildImages } from '@src/utils/images';

export type Props = {
  preview: {
    title: string;
    src: string;
  };
  images?: Array<{
    src: string;
    caption: string;
  }>;
  rangeOptions?: {
    base: string;
    suffix: string;
    digits: number;
    start: number;
    end: number;
    description: string;
  };
};

const { images, rangeOptions, preview } = Astro.props as Props;

const imagesToFetch = images ?? buildImages(rangeOptions);

// TODO - This is extremely slow in development for large image galleries. I wonder if there is a workaround? Maybe store image dimensions in metadata?
const imageData = await Promise.all(
  imagesToFetch.map(async (image) => {
    const trimmedImageSrc = image.src.split('.')[0];
    const finalSrc = `${
      import.meta.env.PUBLIC_IMAGE_BASE_URL
    }${trimmedImageSrc}-2400w.jpg`;
    const res = await fetch(finalSrc);

    console.info('succesfully fetched finalSrc', finalSrc);

    try {
      const arrayBuffer = await res.arrayBuffer();
      const buffer = Buffer.from(arrayBuffer);
      const sharpImage = sharp(buffer);

      const { width, height, format } = await sharpImage.metadata();

      const srcset = [800, 1200, 1800, 2400]
        .filter((w) => w <= width)
        .map((variantWidth) => {
          return `${
            import.meta.env.PUBLIC_IMAGE_BASE_URL
          }${trimmedImageSrc}-${variantWidth}w.jpg ${variantWidth}w`;
        })
        .join(',');

      return {
        src: finalSrc,
        srcset,
        alt: image.caption,
        caption: image.caption,
        width,
        height,
        format,
      };
    } catch (e) {
      console.log('error with image src', finalSrc, e);
    }
  })
);
---

<div>
  <button data-images={JSON.stringify(imageData)} class="gallery-button">
    <BaseImage
      src={preview.src}
      alt={preview.title}
      borderRadiusTop="1em"
      widths={[400, 800]}
    />
    <SlideshowIcon class="gallery-icon" />
    <h5 class="title">{preview.title}</h5>
    <p class="prompt"><em>Click to Open</em></p>
  </button>
</div>

<style>
  .title {
    text-align: center;
    margin: 0.5em auto;
  }

  .gallery-button {
    all: unset;
    display: block;
    cursor: pointer;
    margin: 1em auto;
    max-width: 400px;
    box-shadow: 0 4px 8px #002d5baa;
    transition: var(--dt);
    border-radius: 1em;

    &:hover {
      box-shadow: 0 8px 16px #002d5baa;
    }
  }

  .gallery-icon {
    display: block;
    margin: 0.25em auto;
    font-size: 4em;
    color: var(--color1);
  }

  .prompt {
    font-size: 1rem;
    text-align: center;
  }

  .selected {
    visibility: visible;
    opacity: 1;
    transition: visibility 0s, opacity 0.5s linear;
  }

  .unselected {
    visibility: hidden;
    opacity: 0;
    display: none;
  }
</style>

<script>
  import initializePhotoGalleries from '@src/scripts/imageGallery';

  initializePhotoGalleries();
</script>

---
import BaseImage from './BaseImage.astro';
import 'photoswipe/style.css';
import 'photoswipe-dynamic-caption-plugin/photoswipe-dynamic-caption-plugin.css';

import { nanoid } from 'nanoid';
import sharp from 'sharp';

export type Props = {
  title: string;
  previewSrc: string;
  previewAlt: string;
  images: Array<{
    src: string;
    alt: string;
    caption?: string;
  }>;
};

const { images = [], title, previewSrc, previewAlt } = Astro.props as Props;

const imageData = await Promise.all(
  images.map(async (image) => {
    const finalSrc = `${import.meta.env.PUBLIC_IMAGE_BASE_URL}${image.src}`;
    const res = await fetch(finalSrc);

    const arrayBuffer = await res.arrayBuffer();
    const buffer = Buffer.from(arrayBuffer);
    const sharpImage = sharp(buffer);

    const { width, height, format } = await sharpImage.metadata();
    return {
      ...image,
      src: finalSrc,
      width,
      height,
      format,
    };
  })
);

const sliderId = nanoid(4);
---

<div>
  <button data-slider-id={sliderId} class="gallery-button">
    <BaseImage src={previewSrc} alt={previewAlt} />
  </button>
</div>

<style>
  .title {
    text-align: center;
    margin: 2em auto;
  }

  .gallery-button {
    all: unset;
    display: block;
    cursor: pointer;
    padding: 1em;
    margin: 1em auto;
    max-width: 800px;
  }

  .selected {
    visibility: visible;
    opacity: 1;
    transition: visibility 0s, opacity 0.5s linear;
  }

  .unselected {
    visibility: hidden;
    opacity: 0;
    display: none;
  }
</style>

<script type="module" define:vars={{ sliderId, imageData }}>
  import { initPhotoSwipe, openPhotoSwipe } from '/scripts/initPhotoSwipe.js';

  let currentSlide = 0;

  const handleSlideChange = (lastIndex) => {
    currentSlide = lastIndex;
  };

  const lightbox = initPhotoSwipe(imageData, handleSlideChange);

  document.querySelector(`button[data-slider-id="${sliderId}"]`).onclick =
    () => {
      openPhotoSwipe(lightbox, currentSlide);
    };
</script>
